Option Explicit
Declare Function GetKeyState Lib "user32" (ByVal nVirtKey As Long) As Integer
Public Function PutInClipboard(S As String, Optional FormatID As Variant) As Boolean
End Function
'Microsoft ActiveX Data Objects 6.0 Library

Sub ShowQueryForm()
    SqlQuery.Show (0)
End Sub

Sub ExecuteQuery(S As String)
    Call QueryExcel(S)
End Sub


Sub QueryExcel(ByVal SQL_Statment As String)
On Error GoTo Errhandle
Dim conn As ADODB.Connection
Dim rst As ADODB.Recordset

Dim sConnection As String, sSQL As String
Dim ws As Worksheet
Dim i As Integer, iCheck As Integer
Dim run_records As Long
Dim dSource As String

dSource = ActiveWorkbook.FullName
sConnection = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source = """ & dSource & """;Extended Properties=""Excel 12.0 Xml;HDR=YES;IMEX=0;ReadOnly=False"";"

Set conn = CreateObject("ADODB.Connection")
Set rst = CreateObject("ADODB.Recordset")

sSQL = UCase(SQL_Statment)

conn.Open sConnection

If Left(sSQL, 6) = "UPDATE" Or InStr(sSQL, "INSERT INTO") > 0 Then
    conn.Execute sSQL, run_records
    MsgBox run_records & "records affected", vbInformation
Else

    rst.Open sSQL, conn, adOpenDynamic, adLockOptimistic
    
    Set ws = Worksheets.Add
    With ws
        .Move ThisWorkbook.Worksheets(Sheets.Count)
        
        'Paste Record Set
        Range("A2").CopyFromRecordset rst
        
        For i = 0 To rst.Fields.Count - 1
            .Cells(1, i + 1) = rst.Fields(i).Name
        Next i
        
    End With
    End If
    
Door:
If rst.State <> 0 Then rst.Close
If conn.State <> 0 Then conn.Close

 Set rst = Nothing
 Set conn = Nothing
 Set ws = Nothing
 
Exit Sub

Errhandle:
MsgBox "Error" & Err.Description, vbInformation, "JJ Excel SQL Application"
GoTo Door

End Sub


Sub RunSELECT()
    Dim cn As Object, rs As Object, output As String, sql As String
    
    '---Connecting to the Data Source---
    Set cn = CreateObject("ADODB.Connection")

    With cn
        .Provider = "Microsoft.ACE.OLEDB.12.0"
        .ConnectionString = "Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & ";" & "Extended Properties=""Excel 12.0 Xml;HDR=YES"";"
        .Open
    End With
    
    '---Run the SQL SELECT Query---
    sql = "SELECT * FROM [Sheet1$]"
    Set rs = cn.Execute(sql)
    
    Do
       output = output & """" & rs(0) & """" & ";" & """" & rs(1) & """" & ";" & """" & rs(2) & """" & vbNewLine
       Debug.Print rs(0); ";" & rs(1) & ";" & rs(2)

       rs.Movenext
    Loop Until rs.EOF
    MsgBox output
    
    '---Clean up---
    rs.Close
    cn.Close
    Set cn = Nothing
    Set rs = Nothing
End Sub


Sub setBind()
    Application.OnKey "+^%Q", "ShowQueryForm"
End Sub

Sub PrevSht()
    If Not ActiveSheet.Index = 1 Then Sheets(ActiveSheet.Index - 1).Activate
End Sub

Sub NextSht()
    If Not ActiveSheet.Index = ActiveWorkbook.Sheets.Count Then Sheets(ActiveSheet.Index + 1).Activate
End Sub

