'210621 ws
'_Index  Object  Top Left    Width   Height  LibraryClass    _Text   _TagIn  _TagInColor _TagInVisible   _OpenPic    _Run    _Mes1   _Mes2   _Img    _Hi _Lo

'mod_pc config, after delete
Function pA2fA(inpt As String) As String
    pA2fA = fKey2Val("index", inpt)
End Function

Function io2plc03(inpt As String) As String
    io2plc03 = WorksheetFunction.Substitute(inpt, "X", "PLC03.X.X00")
End Function

Function io2plc00(inpt As String) As String
    io2plc00 = WorksheetFunction.Substitute(inpt, "X", "PLC00.X.X00")
End Function

'mod_ws
Sub downloadXml()
Application.ScreenUpdating = False
Dim d As clsXapDebug: Set d = New clsXapDebug
Dim f As IXMLDOMSelection
Dim sFol As String: sFol = ""
'Dim sFrm As String: sFrm = ""
Dim sCid As String
Dim l As Long
Dim sRet As String

On Error Resume Next

If fGetPgVal("xml_out_sht") = "" Then
   Set ws = ActiveSheet
Else
    Set ws = Sheets(fGetPgVal("xml_out_sht"))
    If ws.Name <> fGetPgVal("xml_out_sht") Then MsgBox "does not exist  : " & fGetPgVal("xml_out_sht"): Exit Sub
End If
    ws.Activate

sFol = fGetPgVal("xml_dl_FolderName")
d.reloadPath
Set f = d.getFolder(sFol)
If f.Length = 0 Then MsgBox "Folder Load Error : " & sFol: Exit Sub

Call d.downloadXml(f)

Set d = Nothing
Set f = Nothing
Set fr = Nothing

'delBlankRow fGetPgVal("xml_dl_HiddenCol")
Application.ScreenUpdating = True
End Sub


Sub downloadFixReport()
Application.ScreenUpdating = False
'If Not ActiveSheet.Tab.ColorIndex = -4142 Then Stop
Dim C As clsXapDebug: Set C = New clsXapDebug
Dim sRet As String

On Error Resume Next

If fGetPgVal("fix_repo_OutSht") = "" Then
    Set ws = ActiveSheet
Else
    Set ws = Sheets(fGetPgVal("fix_repo_OutSht"))
    If ws.Name <> fGetPgVal("fix_repo_OutSht") Then MsgBox "does not exist  : " & fGetPgVal("fix_repo_OutSht"): Exit Sub
End If

With ws
    .Activate
    .Cells.Clear
    .Range(Cells(1, 1), Cells(1, Columns("S").Column)).Value2 = Split("_Index,Object,Top,Left,Width,Height,LibraryClass,_Text,_TagIn,_TagInColor,_TagInVisible,_OpenPic,_Run,_Mes1,_Mes2,_Img,_Hi,_Lo,_Del", ",")
    C.reloadPath
    C.downloadFixReport
End With

Set C = Nothing
Application.ScreenUpdating = True
End Sub


Sub uploadFixReport()
Application.ScreenUpdating = False
'If Not ActiveSheet.Tab.ColorIndex = -4142 Then Stop
Dim C As clsXapDebug: Set C = New clsXapDebug
Dim sRet As String
Dim ws As Worksheet
On Error Resume Next

If fGetPgVal("fix_repo_OutSht") = "" Then
    Set ws = ActiveSheet
Else
    Set ws = Sheets(fGetPgVal("fix_repo_OutSht"))
    If ws.Name <> fGetPgVal("fix_repo_OutSht") Then MsgBox "does not exist  : " & fGetPgVal("fix_repo_OutSht"): Exit Sub
End If

With ws
    .Activate
    C.reloadPath
    C.createFixFilterXml
End With

MsgBox "uploaFixReport :" & fGetPgVal("fix_repo_OutPath")

Set C = Nothing
Application.ScreenUpdating = True
End Sub


Sub uploadFixReportB()
Application.ScreenUpdating = False
Application.DisplayAlerts = False
'If Not ActiveSheet.Tab.ColorIndex = -4142 Then Stop
Dim C As clsXapDebug: Set C = New clsXapDebug
Dim vFiles As FileDialog: Set vFiles = Application.FileDialog(msoFileDialogFilePicker)
Dim vSelectFiles As FileDialogSelectedItems
Dim vCnt As Long
Dim sRet As String
Dim wb As Workbook

With vFiles
    .Filters.Clear
'    .Filters.Add "pictureFile", "*.*", 1
    '.Title = "FILE SELECT"
    .AllowMultiSelect = True
    .InitialFileName = fGetPgVal("fix_repo_dir")
    .show
End With

On Error Resume Next
If vFiles.SelectedItems.Count = 0 Then Exit Sub: Exit Sub
Set wb = Workbooks.Add: wb.Activate

For vCnt = 1 To vFiles.SelectedItems.Count ' 1 base array
    With wb.Worksheets.Add
        .Range(Cells(1, 1), Cells(1, Columns("S").Column)).Value2 = Split("_Index,Object,Top,Left,Width,Height,LibraryClass,_Text,_TagIn,_TagInColor,_TagInVisible,_OpenPic,_Run,_Mes1,_Mes2,_Img,_Hi,_Lo,_Del", ",")
        sRet = fSetPgVal("fix_repo_InPath", vFiles.SelectedItems(vCnt))
        sRet = fSetPgVal("fix_repo_OutPath", fReplace(vFiles.SelectedItems(vCnt), ".ODR", ".xml"))
        C.reloadPath
        C.downloadFixReport
        .Name = fSplit(Dir(vFiles.SelectedItems(vCnt)), 1, ".")
        C.createFixFilterXml
    End With
Next vCnt
wb.Sheets("Sheet1").Delete

Set C = Nothing
Application.ScreenUpdating = True
Application.DisplayAlerts = True
End Sub


Function Alias2Cmt(inpt As String) As String
'Alias or PLC03.M.M00800 => PLC03.M.M00800
'=>PLC03_M800
'=>PLC03_KEIKI
'=>PLC03_X1

Dim sAdr As String
Dim sFind As String
Dim sDev As String
Dim sKey As String
Dim sRslt As String

If UBound(Split(inpt, ".")) = 2 Then sAdr = inpt Else sAdr = fKey2Val("SRC_Alias", inpt)

sFind = fSplit(sAdr, 3, ".")
sFind = fReplaceRegx(sFind, "[A-Z]+", "")
sFind = fSplit(sFind, 1, "@")
sFind = CInt(sFind)
sDev = sFind
Stop
'MDR device
If sFind > 999 Then
    sFind = Left(sFind, Len(sFind) - 2) & Application.WorksheetFunction.Rept(0, 2)
ElseIf sFind < 1000 And sFind > 99 Then
    sFind = Left(sFind, 1) & Application.WorksheetFunction.Rept(0, Len(sFind) - 1)
Else
    sFind = 100
End If

sKey = fSplit(sAdr, 1, ".") & "_" & fSplit(sAdr, 2, ".") & sFind
sRslt = fKey2Val(sKey, fSplit(sAdr, 2, ".") & fDigitN(sDev, 4))
If Not sRslt = "#N\A#" Then Dev2Cmt = sRslt: Exit Function

'XY device
If sFind > 999 Then
    sFind = Left(sFind, Len(sFind) - 2) & Application.WorksheetFunction.Rept(0, 2)
ElseIf sFind < 1000 And sFind > 99 Then
    sFind = Left(sFind, 1) & Application.WorksheetFunction.Rept(0, Len(sFind) - 1)
Else
    sFind = 100
End If
sKey = fSplit(sAdr, 1, ".") & "_" & fSplit(sAdr, 2, ".") & sFind
sRslt = fKey2Val(sKey, fSplit(sAdr, 2, ".") & fDigitN(sDev, 3))
If Not sRslt = "#N\A#" Then Dev2Cmt = sRslt: Exit Function

'keiki
sRslt = fKey2Val(fSplit(sAdr, 1, ".") & "_Keiki", sAdr)

Dev2Cmt = sRslt

End Function






